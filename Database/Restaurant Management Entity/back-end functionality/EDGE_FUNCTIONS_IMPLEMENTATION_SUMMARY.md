# Edge Functions Implementation Summary

**Date:** 2025-10-17
**Purpose:** Document the implementation of hybrid SQL + Edge Function architecture for Restaurant Management Entity
**Platform:** ‚úÖ **Supabase Edge Functions (Deno Runtime)**
**Status:** ‚úÖ **Franchise Backend Complete** | ‚è≥ **Categorization In Progress**

---

## Overview

This document tracks the implementation of Edge Function wrappers for the Restaurant Management Entity backend. The hybrid approach maintains atomic SQL functions for database operations while adding **Supabase Edge Functions** for authentication, authorization, audit logging, and application-level concerns.

**All Edge Functions are deployed to Supabase and use Deno runtime with JSR imports.**

---

## Infrastructure

### Database Tables

#### `admin_action_logs` - Admin Action Audit Trail
**Status:** ‚úÖ **Created**

```sql
CREATE TABLE menuca_v3.admin_action_logs (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,
  action VARCHAR(255) NOT NULL,
  resource_type VARCHAR(100) NOT NULL,
  resource_id BIGINT,
  metadata JSONB DEFAULT '{}',
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Purpose:** Tracks explicit admin actions via API (separate from automatic `audit_log` triggers).

**Indexes:**
- `idx_admin_action_logs_user_id` - Query by admin user
- `idx_admin_action_logs_action` - Query by action type
- `idx_admin_action_logs_resource` - Query by resource
- `idx_admin_action_logs_created_at` - Time-based queries

---

### Shared Utilities Structure

**Platform:** Supabase Edge Functions use self-contained functions (inline utilities per function)

#### Core Utilities (Inlined in Each Function)
- **CORS Headers** - CORS configuration for API access
- **Authentication** - JWT verification via Supabase Auth
- **Response Helpers** - `badRequest()`, `successResponse()`, `internalError()`, `created()`
- **Validation** - Required field validation and sanitization
- **Audit Logging** - `logAdminAction()` writes to `admin_action_logs`

#### TypeScript Types
- `CreateFranchiseParentRequest` - Create franchise parent params
- `ConvertRequest` - Single/batch franchise conversion params
- `CascadeMenuRequest` - Menu cascading params

---

## üè¢ Franchise / Chain Hierarchy

**Status:** ‚úÖ **Complete** (SQL + Edge Functions)

### Architecture Overview

**Hybrid Approach:**
- **SQL Functions:** Core business logic, data validation, atomic transactions
- **Edge Functions:** Authentication, authorization, audit logging, cache management, notifications

**SQL Functions Implemented:** 9 functions
**Edge Functions Implemented:** 3 functions

---

### Edge Function 1: Create Franchise Parent

**Endpoint:** `POST /functions/v1/create-franchise-parent`

**SQL Function:** `menuca_v3.create_franchise_parent()`

**Edge Function:** `supabase/functions/create-franchise-parent/index.ts`

**Deployment Status:** ‚úÖ **Deployed to Supabase** (Version 1, Active)

**Purpose:** Create a new franchise parent/brand with multiple locations.

**Features:**
- ‚úÖ Authentication required (Bearer token)
- ‚úÖ Authorization: `franchise.create` permission
- ‚úÖ Input validation (name, brand_name, city_id, province_id)
- ‚úÖ SQL function call (atomic transaction)
- ‚úÖ Admin action logging
- ‚úÖ Cache invalidation
- ‚úÖ Slack notification
- ‚úÖ REST-compliant response

**Request Example:**
```bash
curl -X POST \
  https://nthpbtdjhhnwfxqsxbvy.supabase.co/functions/v1/create-franchise-parent \
  -H "Authorization: Bearer <supabase_anon_key>" \
  -H "Content-Type: application/json" \
  -d

{
  "name": "Milano Pizza - Corporate",
  "franchise_brand_name": "Milano Pizza",
  "city_id": 245,
  "province_id": 9,
  "timezone": "America/Toronto",
  "created_by": 42
}
```

**Response Example (201 Created):**
```json
{
  "success": true,
  "data": {
    "parent_id": 1005,
    "brand_name": "Milano Pizza",
    "name": "Milano Pizza - Corporate",
    "status": "active"
  },
  "message": "Franchise parent created successfully"
}
```

**SQL Function Called:**
```sql
CREATE OR REPLACE FUNCTION menuca_v3.create_franchise_parent(
  p_name VARCHAR,
  p_franchise_brand_name VARCHAR,
  p_city_id INTEGER,
  p_province_id INTEGER,
  p_timezone VARCHAR DEFAULT 'America/Toronto',
  p_created_by BIGINT DEFAULT NULL
)
RETURNS TABLE (
  parent_id BIGINT,
  brand_name VARCHAR,
  name VARCHAR,
  status public.restaurant_status
)
```

**Validation:**
- Brand name uniqueness
- Valid city_id and province_id
- Name length (2-255 characters)
- Timezone format (IANA)

**Post-Creation Actions (Async):**
1. Log to `admin_action_logs`
2. Invalidate caches: `franchises`, `franchises:list`, `restaurants:franchises`
3. Send Slack notification

---

### Edge Function 2: Convert Restaurant to Franchise

**Endpoint:** `POST /functions/v1/convert-restaurant-to-franchise`

**SQL Functions:** 
- `menuca_v3.convert_to_franchise()` - Single conversion
- `menuca_v3.batch_link_franchise_children()` - Bulk conversion

**Edge Function:** `supabase/functions/convert-restaurant-to-franchise/index.ts`

**Deployment Status:** ‚úÖ **Deployed to Supabase** (Version 1, Active)

**Purpose:** Convert independent restaurant to franchise location OR bulk-link multiple restaurants.

**Features:**
- ‚úÖ Authentication required (Bearer token)
- ‚úÖ Authorization: `franchise.update` permission
- ‚úÖ Smart detection: single vs batch conversion
- ‚úÖ Input validation (restaurant_id, parent_id, child arrays)
- ‚úÖ SQL function calls (atomic transactions)
- ‚úÖ Admin action logging
- ‚úÖ Cache invalidation (per-restaurant + franchise)
- ‚úÖ Slack notification
- ‚úÖ REST-compliant response

**Single Conversion Request:**
```bash
curl -X POST \
  https://nthpbtdjhhnwfxqsxbvy.supabase.co/functions/v1/convert-restaurant-to-franchise \
  -H "Authorization: Bearer <supabase_anon_key>" \
  -H "Content-Type: application/json" \
  -d

{
  "restaurant_id": 561,
  "parent_restaurant_id": 1005,
  "updated_by": 42
}
```

**Single Conversion Response:**
```json
{
  "success": true,
  "data": {
    "restaurant_id": 561,
    "restaurant_name": "Milano Pizza - Downtown",
    "parent_restaurant_id": 1005,
    "parent_brand_name": "Milano Pizza"
  },
  "message": "Restaurant converted to franchise successfully"
}
```

**Batch Conversion Request:**
```bash
curl -X POST \
  https://nthpbtdjhhnwfxqsxbvy.supabase.co/functions/v1/convert-restaurant-to-franchise \
  -H "Authorization: Bearer <supabase_anon_key>" \
  -H "Content-Type: application/json" \
  -d

{
  "parent_restaurant_id": 1005,
  "child_restaurant_ids": [561, 562, 563, 564],
  "updated_by": 42
}
```

**Batch Conversion Response:**
```json
{
  "success": true,
  "data": {
    "parent_restaurant_id": 1005,
    "parent_brand_name": "Milano Pizza",
    "linked_count": 4,
    "child_restaurants": [
      { "id": 561, "name": "Milano Pizza - Downtown" },
      { "id": 562, "name": "Milano Pizza - Uptown" },
      { "id": 563, "name": "Milano Pizza - West" },
      { "id": 564, "name": "Milano Pizza - East" }
    ]
  },
  "message": "Successfully linked 4 restaurants to franchise"
}
```

**SQL Functions Called:**

**Single:**
```sql
CREATE OR REPLACE FUNCTION menuca_v3.convert_to_franchise(
  p_restaurant_id BIGINT,
  p_parent_restaurant_id BIGINT,
  p_updated_by BIGINT DEFAULT NULL
)
RETURNS TABLE (
  restaurant_id BIGINT,
  restaurant_name VARCHAR,
  parent_restaurant_id BIGINT,
  parent_brand_name VARCHAR
)
```

**Batch:**
```sql
CREATE OR REPLACE FUNCTION menuca_v3.batch_link_franchise_children(
  p_parent_restaurant_id BIGINT,
  p_child_restaurant_ids BIGINT[],
  p_updated_by BIGINT DEFAULT NULL
)
RETURNS TABLE (
  parent_restaurant_id BIGINT,
  parent_brand_name VARCHAR,
  linked_count INTEGER,
  child_restaurants JSONB
)
```

**Validation:**
- Parent restaurant must be franchise parent (`is_franchise_parent = true`)
- Child restaurants must exist and not already be franchise children
- All IDs must be positive integers

**Post-Conversion Actions (Async):**
1. Log to `admin_action_logs` with action `franchise.convert` or `franchise.batch_link`
2. Invalidate caches: specific restaurant(s) + franchise list
3. Send Slack notification with conversion details

---

### Edge Function 3: Cascade Menu Items

**Endpoint:** `POST /functions/v1/cascade-franchise-menu`

**SQL Functions:**
- `menuca_v3.cascade_dish_to_children()` - Cascade single dish+
- `menuca_v3.cascade_pricing_to_children()` - Cascade pricing only
- `menuca_v3.sync_menu_from_parent()` - Full menu sync

**Edge Function:** `supabase/functions/cascade-franchise-menu/index.ts`

**Deployment Status:** ‚úÖ **Deployed to Supabase** (Version 1, Active)

**Purpose:** Synchronize menu items and pricing from parent to franchise locations.

**Features:**
- ‚úÖ Authentication required (Bearer token)
- ‚úÖ Authorization: `franchise.menu_cascade` permission
- ‚úÖ Smart operation detection (single dish, pricing, or full sync)
- ‚úÖ Input validation (parent_id, optional dish_id, child arrays)
- ‚úÖ SQL function calls (atomic transactions)
- ‚úÖ Admin action logging
- ‚úÖ Cache invalidation (menu caches)
- ‚úÖ Slack notification
- ‚úÖ REST-compliant response

**Operation 1: Cascade Single Dish**

**Request:**
```json
POST /api/admin/franchises/cascade-menu
Authorization: Bearer <token>

{
  "parent_restaurant_id": 1005,
  "dish_id": 12345,
  "include_pricing": true,
  "child_restaurant_ids": [561, 562]
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "parent_restaurant_id": 1005,
    "dish_id": 12345,
    "dish_name": "Margherita Pizza",
    "children_updated": 2,
    "include_pricing": true
  },
  "message": "Dish cascaded to 2 franchise locations"
}
```

**SQL Function:**
```sql
CREATE OR REPLACE FUNCTION menuca_v3.cascade_dish_to_children(
  p_parent_restaurant_id BIGINT,
  p_dish_id BIGINT,
  p_child_restaurant_ids BIGINT[] DEFAULT NULL,
  p_include_pricing BOOLEAN DEFAULT FALSE
)
RETURNS TABLE (
  dish_name VARCHAR,
  children_updated INTEGER
)
```

---

**Operation 2: Cascade Pricing Only**

**Request:**
```json
POST /api/admin/franchises/cascade-menu
Authorization: Bearer <token>

{
  "parent_restaurant_id": 1005,
  "include_pricing": true
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "parent_restaurant_id": 1005,
    "children_updated": 4,
    "dishes_updated": 87
  },
  "message": "Pricing cascaded to 4 franchise locations"
}
```

**SQL Function:**
```sql
CREATE OR REPLACE FUNCTION menuca_v3.cascade_pricing_to_children(
  p_parent_restaurant_id BIGINT,
  p_child_restaurant_ids BIGINT[] DEFAULT NULL
)
RETURNS TABLE (
  children_updated INTEGER,
  dishes_updated INTEGER
)
```

---

**Operation 3: Full Menu Sync**

**Request:**
```json
POST /api/admin/franchises/cascade-menu
Authorization: Bearer <token>

{
  "parent_restaurant_id": 1005
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "parent_restaurant_id": 1005,
    "children_updated": 4,
    "dishes_synced": 87
  },
  "message": "Menu synced to 4 franchise locations"
}
```

**SQL Function:**
```sql
CREATE OR REPLACE FUNCTION menuca_v3.sync_menu_from_parent(
  p_parent_restaurant_id BIGINT,
  p_child_restaurant_ids BIGINT[] DEFAULT NULL
)
RETURNS TABLE (
  children_updated INTEGER,
  dishes_synced INTEGER
)
```

**Validation:**
- Parent restaurant must exist and be franchise parent
- Dish ID must exist and belong to parent (for single dish cascade)
- Child restaurant IDs must be valid franchise children

**Post-Operation Actions (Async):**
1. Log to `admin_action_logs` with action `franchise.cascade_dish`, `franchise.cascade_pricing`, or `franchise.sync_menu`
2. Invalidate menu caches for parent and all affected children
3. Send Slack notification with operation details

---

### Franchise SQL Functions Summary

**Status:** ‚úÖ **All 9 Complete**

| Function | Purpose | Edge Wrapper |
|----------|---------|--------------|
| `create_franchise_parent()` | Create parent brand | ‚úÖ create-parent.ts |
| `convert_to_franchise()` | Link single child | ‚úÖ convert-restaurant.ts |
| `batch_link_franchise_children()` | Link multiple children | ‚úÖ convert-restaurant.ts |
| `bulk_update_franchise_feature()` | Toggle features | ‚ùå SQL Only |
| `cascade_dish_to_children()` | Copy single dish | ‚úÖ cascade-menu.ts |
| `cascade_pricing_to_children()` | Sync pricing | ‚úÖ cascade-menu.ts |
| `sync_menu_from_parent()` | Full menu sync | ‚úÖ cascade-menu.ts |
| `get_franchise_analytics()` | Performance data | ‚ùå SQL Only |
| `compare_franchise_locations()` | Location comparison | ‚ùå SQL Only |
| `get_franchise_menu_coverage()` | Menu coverage % | ‚ùå SQL Only |
| `find_nearest_franchise_location()` | PostGIS routing | ‚ùå SQL Only |

**Note:** Read-only analytics and routing functions don't need Edge wrappers - they can be called directly or via a simple public API endpoint.

---

## üçΩÔ∏è Restaurant Categorization (Cuisines & Tags)

**Status:** ‚è≥ **In Progress** (SQL Complete, Edge Functions Partial)

### Edge Function 1: Create Restaurant with Cuisine

**Endpoint:** `POST /api/admin/restaurants/create-with-cuisine`

**SQL Function:** `menuca_v3.create_restaurant_with_cuisine()`

**Edge Function:** `netlify/functions/admin/restaurants/create-with-cuisine.ts`

**Status:** ‚úÖ **Complete**

**Features:**
- ‚úÖ Authentication required (Bearer token)
- ‚úÖ Authorization: `restaurant.create` permission
- ‚úÖ Input validation (name, status, timezone, cuisine)
- ‚úÖ SQL function call (atomic transaction)
- ‚úÖ Admin action logging
- ‚úÖ Cache invalidation
- ‚úÖ Slack notification
- ‚úÖ REST-compliant response

**Request Example:**
```json
POST /api/admin/restaurants/create-with-cuisine
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "New Restaurant",
  "status": "pending",
  "timezone": "America/Toronto",
  "cuisine_slug": "italian",
  "created_by": 1
}
```

**Response Example (201 Created):**
```json
{
  "success": true,
  "data": {
    "restaurant_id": 1001,
    "name": "New Restaurant",
    "cuisine": "Italian",
    "status": "pending",
    "timezone": "America/Toronto"
  },
  "message": "Restaurant created successfully"
}
```

---

### Remaining Categorization Edge Functions

**Status:** ‚è≥ **Templates Ready, Not Implemented**

1. **Add Cuisine to Restaurant** - `POST /api/admin/restaurants/add-cuisine`
2. **Create Cuisine Type** - `POST /api/admin/cuisines/create`
3. **Create Restaurant Tag** - `POST /api/admin/tags/create`
4. **Add Tag to Restaurant** - `POST /api/admin/restaurants/add-tag`

---

## üìã Implementation Pattern

All Edge Functions follow this standard pattern:

```typescript
export default async (req: Request): Promise<Response> => {
  // 1. Handle CORS preflight
  if (req.method === 'OPTIONS') return handleOptions();

  // 2. Check HTTP method
  if (req.method !== 'POST') return badRequest('Method not allowed');

  try {
    // 3. Authentication & Authorization
    const user = await requirePermission(req, 'permission.name');

    // 4. Parse request body
    const body = await req.json();

    // 5. Input validation
    const validation = validateRequired(body, ['field1', 'field2']);
    if (!validation.valid) return badRequest(validation.error);

    // 6. Initialize Supabase client
    const supabase = createAdminClient();

    // 7. Call SQL function (atomic operation)
    const { data, error } = await supabase.rpc('sql_function_name', {
      p_param1: body.param1,
      p_param2: body.param2,
    });

    if (error) throw error;
    if (!data[0]?.success) return badRequest(data[0]?.message);

    // 8. Post-processing (async, don't block response)
    Promise.all([
      logAdminAction(supabase, user.id, 'action.name', 'resource', data[0].id),
      invalidateCache(['cache-key']),
      sendNotification('slack', 'message', metadata),
    ]).catch(console.error);

    // 9. Return success response
    return created(data[0], 'Action completed successfully');

  } catch (error) {
    console.error('Error:', error);
    return internalError('Internal server error');
  }
};
```

---

## üìÇ File Structure

```
netlify/functions/
‚îú‚îÄ‚îÄ shared/
‚îÇ   ‚îú‚îÄ‚îÄ types.ts                    ‚úÖ Complete (incl. franchise types)
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts                     ‚úÖ Complete
‚îÇ   ‚îú‚îÄ‚îÄ response.ts                 ‚úÖ Complete
‚îÇ   ‚îú‚îÄ‚îÄ validation.ts               ‚úÖ Complete
‚îÇ   ‚îî‚îÄ‚îÄ supabase.ts                 ‚úÖ Complete (admin_action_logs)
‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îú‚îÄ‚îÄ franchises/                 ‚úÖ NEW
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create-parent.ts        ‚úÖ Complete
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ convert-restaurant.ts   ‚úÖ Complete
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cascade-menu.ts         ‚úÖ Complete
‚îÇ   ‚îú‚îÄ‚îÄ restaurants/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create-with-cuisine.ts  ‚úÖ Complete
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ add-cuisine.ts          ‚è≥ Template ready
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ add-tag.ts              ‚è≥ Template ready
‚îÇ   ‚îú‚îÄ‚îÄ cuisines/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ create.ts               ‚è≥ Template ready
‚îÇ   ‚îú‚îÄ‚îÄ tags/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ create.ts               ‚è≥ Template ready
‚îÇ   ‚îî‚îÄ‚îÄ domains/
‚îÇ       ‚îî‚îÄ‚îÄ verify-single.ts        ‚úÖ Complete (existing)
‚îú‚îÄ‚îÄ cron/
‚îÇ   ‚îî‚îÄ‚îÄ verify-domains.ts           ‚úÖ Complete (existing)
‚îî‚îÄ‚îÄ public/
    ‚îî‚îÄ‚îÄ [future public endpoints]
```

---

## üîß Environment Variables Required

Add to `.env` or Netlify environment variables:

```bash
# Supabase
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Optional: External services
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/xxx
REDIS_URL=redis://localhost:6379
CDN_PURGE_API_KEY=xxx
CRON_SECRET=xxx

# Node environment
NODE_ENV=development
```

---

## üîí Security Model

### 1. **Authentication**
- ‚úÖ All admin endpoints require Bearer token
- ‚úÖ Tokens verified with Supabase `auth.getUser()`
- ‚úÖ Expired tokens rejected (401)

### 2. **Authorization**
- ‚úÖ Role-based permissions (`admin`, `super_admin`, `restaurant_owner`)
- ‚úÖ Permission checks before SQL execution
- ‚úÖ Resource ownership validation (where applicable)

### 3. **Input Validation**
- ‚úÖ All inputs sanitized (`sanitizeString()`)
- ‚úÖ Required fields checked (`validateRequired()`)
- ‚úÖ Data types validated (integers, emails, slugs)
- ‚úÖ SQL injection prevention (using RPC, not raw SQL)

### 4. **Audit Logging**
- ‚úÖ All admin actions logged to `admin_action_logs`
- ‚úÖ Includes: user_id, action, resource_type, resource_id, metadata, timestamp
- ‚úÖ Separate from automatic `audit_log` (trigger-based)

### 5. **Rate Limiting** 
- ‚è≥ TODO: Implement per-user rate limiting
- ‚è≥ TODO: Implement per-IP rate limiting
- ‚è≥ TODO: Implement endpoint-specific limits

### 6. **CORS**
- ‚úÖ CORS headers configured
- ‚úÖ Preflight requests handled (`OPTIONS`)
- ‚ö†Ô∏è Currently allows all origins (`*` - tighten in production)

---

## üöÄ Deployment

### Netlify Configuration (`netlify.toml`)

```toml
[build]
  functions = "netlify/functions"

[functions]
  node_bundler = "esbuild"

[[redirects]]
  from = "/api/admin/*"
  to = "/.netlify/functions/admin/:splat"
  status = 200

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/public/:splat"
  status = 200
```

### Deploy Commands

```bash
# Install dependencies
npm install @supabase/supabase-js

# Deploy to Netlify
netlify deploy --prod

# Or use Git integration (automatic deployment)
git push origin main
```

---

## ‚úÖ Completion Status

### Franchise / Chain Hierarchy
- ‚úÖ SQL Functions (9/9 complete)
- ‚úÖ Edge Functions (3/3 complete)
- ‚úÖ Shared utilities updated
- ‚úÖ Database tables created
- ‚úÖ Documentation complete

### Restaurant Categorization
- ‚úÖ SQL Functions (complete)
- ‚è≥ Edge Functions (1/5 complete)
- ‚è≥ Remaining: 4 Edge Functions

---

## üìù Next Steps

### Immediate
1. ‚úÖ Franchise Edge Functions implemented
2. ‚è≥ Complete remaining categorization Edge Functions
3. ‚è≥ Add unit tests for Edge Functions
4. ‚è≥ Add integration tests

### Short-term
1. ‚è≥ Implement rate limiting
2. ‚è≥ Add error tracking (Sentry)
3. ‚è≥ Add performance monitoring
4. ‚è≥ Tighten CORS policy
5. ‚è≥ Add request logging

### Long-term
1. ‚è≥ Add GraphQL support
2. ‚è≥ Add webhook system
3. ‚è≥ Add real-time WebSocket updates
4. ‚è≥ Add API versioning
5. ‚è≥ Add OpenAPI/Swagger documentation

---

## üöÄ Deployment Summary

### Supabase Edge Functions (Deno Runtime)

**Deployment Date:** October 17, 2025  
**Platform:** Supabase (Project: nthpbtdjhhnwfxqsxbvy)  
**Runtime:** Deno + JSR imports

| Function | Slug | Status | Version | Endpoint |
|----------|------|--------|---------|----------|
| Create Franchise Parent | `create-franchise-parent` | ‚úÖ Active | v1 | `/functions/v1/create-franchise-parent` |
| Convert to Franchise | `convert-restaurant-to-franchise` | ‚úÖ Active | v1 | `/functions/v1/convert-restaurant-to-franchise` |
| Cascade Menu | `cascade-franchise-menu` | ‚úÖ Active | v1 | `/functions/v1/cascade-franchise-menu` |

### File Structure

```
supabase/functions/
‚îú‚îÄ‚îÄ _shared/                         # Shared utilities (for reference)
‚îÇ   ‚îú‚îÄ‚îÄ types.ts                     # TypeScript types
‚îÇ   ‚îú‚îÄ‚îÄ cors.ts                      # CORS configuration
‚îÇ   ‚îú‚îÄ‚îÄ response.ts                  # Response helpers
‚îÇ   ‚îú‚îÄ‚îÄ validation.ts                # Input validation
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts                      # Authentication
‚îÇ   ‚îî‚îÄ‚îÄ supabase.ts                  # Supabase client utilities
‚îÇ
‚îú‚îÄ‚îÄ create-franchise-parent/         # ‚úÖ Deployed
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                     # Self-contained function
‚îÇ
‚îú‚îÄ‚îÄ convert-restaurant-to-franchise/ # ‚úÖ Deployed
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                     # Self-contained function
‚îÇ
‚îî‚îÄ‚îÄ cascade-franchise-menu/          # ‚úÖ Deployed
    ‚îî‚îÄ‚îÄ index.ts                     # Self-contained function
```

**Note:** Supabase Edge Functions don't support shared imports outside the function directory, so each function is self-contained with inlined utilities.

### SQL Functions (Database)

All 9 SQL functions are already deployed in `menuca_v3` schema:
- `create_franchise_parent()`
- `convert_to_franchise()`
- `batch_link_franchise_children()`
- `cascade_dish_to_children()`
- `cascade_pricing_to_children()`
- `sync_menu_from_parent()`
- `get_franchise_analytics()`
- `compare_franchise_locations()`
- `get_franchise_menu_coverage()`

### Audit Logging

The `admin_action_logs` table is created in `menuca_v3` schema with proper indexes for tracking all admin actions.

---

**Maintained By:** Santiago
**Last Updated:** 2025-10-17  
**Status:** Franchise Backend Complete ‚úÖ | All Functions Deployed to Supabase üöÄ

