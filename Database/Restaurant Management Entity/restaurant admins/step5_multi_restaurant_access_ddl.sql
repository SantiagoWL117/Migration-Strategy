-- ============================================================================
-- Step 5a: Create Junction Table for Multi-Restaurant Access (OPTIONAL)
-- ============================================================================
-- Purpose: Handle V1 allowed_restaurants BLOB data for multi-restaurant access
-- Author: Migration Plan
-- Date: 2025-10-02
-- ============================================================================
-- NOTE: This step is OPTIONAL and only needed if multi-restaurant access
--       functionality is required in the new system.
-- ============================================================================

\echo 'üîß Creating junction table for multi-restaurant access...'
\echo ''

BEGIN;

-- Create junction table
CREATE TABLE IF NOT EXISTS menuca_v3.restaurant_admin_access (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  admin_user_id bigint NOT NULL REFERENCES menuca_v3.restaurant_admin_users(id) ON DELETE CASCADE,
  restaurant_id bigint NOT NULL REFERENCES menuca_v3.restaurants(id) ON DELETE CASCADE,
  granted_at timestamptz DEFAULT now() NOT NULL,
  granted_by integer,
  UNIQUE(admin_user_id, restaurant_id)
);

-- Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_admin_access_user 
  ON menuca_v3.restaurant_admin_access(admin_user_id);

CREATE INDEX IF NOT EXISTS idx_admin_access_restaurant 
  ON menuca_v3.restaurant_admin_access(restaurant_id);

COMMIT;

\echo '‚úÖ Junction table created: menuca_v3.restaurant_admin_access'
\echo ''
\echo 'üìù Table structure:'
\d+ menuca_v3.restaurant_admin_access;

\echo ''
\echo 'üìù Next steps:'
\echo '   1. Parse V1 allowed_restaurants BLOB data (PHP serialized arrays)'
\echo '   2. Load parsed data into staging table (see step5b)'
\echo '   3. Populate junction table from staging (see step5c)'
\echo ''
\echo '   Note: V1 allowed_restaurants contains PHP serialized arrays like:'
\echo '   a:847:{i:0;s:2:"72";i:1;s:2:"89";...}'
\echo '   This represents an array of restaurant IDs the user can access.'
\echo ''




