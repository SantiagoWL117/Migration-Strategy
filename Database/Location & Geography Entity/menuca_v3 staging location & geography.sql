-- Supabase-ready DDL for location reference tables extracted from MySQL dump
-- Source tables and inferred versions:
--  - cities_v1      (v1)
--  - counties_v1    (v1)
--  - cities_v2      (v2)
--  - provinces_v2   (v2)

-- Schemas
CREATE SCHEMA IF NOT EXISTS staging;
CREATE SCHEMA IF NOT EXISTS menuca_v3;

-- =========================
-- STAGING (raw imports)
-- =========================

-- v1: cities_v1
DROP TABLE IF EXISTS staging.cities_v1;
CREATE TABLE staging.cities_v1 (
  id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name varchar(50),
  display_name varchar(125),
  county integer NOT NULL DEFAULT 0,
  country integer NOT NULL DEFAULT 0,
  lat varchar(45),
  lng varchar(45),
  timezone varchar(45)
);

-- v2: cities_v2 (uses province_id + precise coordinates)
DROP TABLE IF EXISTS staging.cities_v2;
CREATE TABLE staging.cities_v2 (
  id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name varchar(50),
  province_id smallint DEFAULT 0,
  lat numeric(13,10),
  lng numeric(13,10),
  timezone varchar(45)
);
CREATE INDEX IF NOT EXISTS idx_cities_v2_province_id ON staging.cities_v2 (province_id);

-- v2: provinces_v2
DROP TABLE IF EXISTS staging.provinces_v2;
CREATE TABLE staging.provinces_v2 (
  id smallint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name varchar(125) NOT NULL,
  short_name char(3)
);

-- =========================
-- menuca_v3 (canonical refs)
-- =========================

-- Canonical provinces table
DROP TABLE IF EXISTS menuca_v3.provinces;
CREATE TABLE menuca_v3.provinces (
  id smallint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name varchar(125) NOT NULL,
  short_name char(3)
);

-- Canonical cities table (superset covering v1/v2)
DROP TABLE IF EXISTS menuca_v3.cities;
CREATE TABLE menuca_v3.cities (
  id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name varchar(125) NOT NULL,
  display_name varchar(125),
  province_id smallint,
  lat numeric(13,10),
  lng numeric(13,10),
  timezone varchar(45),
  CONSTRAINT cities_province_id_fkey FOREIGN KEY (province_id) REFERENCES menuca_v3.provinces(id)
);
CREATE INDEX IF NOT EXISTS idx_cities_province_id ON menuca_v3.cities (province_id);


