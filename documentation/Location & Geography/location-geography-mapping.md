## Location & Geography Entity: Source → menuca_v3 Mapping

This document maps essential fields from V1/V2 Location & Geography tables to the normalized Supabase-ready schema created under `menuca_v3`.

### Scope Sources

**V1 Tables:** 
- `addresses` - Geocoded address searches
- `ca` - Canadian postal code reference
- `cities` - City master data
- `counties` - Province data (legacy name)
- `neighbourhood` - Neighborhood boundaries
- `restaurant_delivery_areas` - Restaurant delivery zones
- `restaurant_areas` - Restaurant coverage areas
- `restaurant_locations` - Franchise/multi-location data

**V2 Tables:**
- `cities` - Improved city reference
- `provinces` - Province/state master data
- `address_searches` - Google Places API results
- `restaurants_delivery_areas` - Delivery area polygons with geometry

### Target Schema Tables

**menuca_v3 tables** (already created):
- `menuca_v3.provinces` - Canonical province/state reference
- `menuca_v3.cities` - Canonical city reference  
- `menuca_v3.restaurant_locations` - Restaurant physical addresses (part of Restaurant Management)

**Note:** The `restaurant_locations` table in menuca_v3 is the primary location storage for restaurants. It includes geography references (city, province) via foreign keys to the canonical geography tables.

---

## Canonical Geography Reference Tables

### menuca_v3.provinces

Canonical province/state reference table. Migrate from V2 first (more complete), backfill from V1 if needed.

| Target Column | V1 Source | V2 Source | Transform / Notes |
|---|---|---|---|
| **id** | n/a | n/a | SMALLINT generated by `provinces_id_seq` |
| **name** | `counties.name` | `provinces.name` | Direct copy; V2 preferred as authoritative |
| **short_name** | `counties.short_name` | `provinces.short_name` | 2-3 char abbreviation (e.g., 'ON', 'QC') |

**Migration Priority:** V2 `provinces` is the authoritative source. V1 `counties` used only to validate or backfill missing data.

**Key Mapping Notes:**
- V1 uses `counties` (legacy naming) - should map to provinces
- V2 `provinces` has cleaner structure with proper naming
- Deduplicate by `(name, short_name)` unique constraint

---

### menuca_v3.cities

Canonical city reference table with geography coordinates and timezone data.

| Target Column | V1 Source | V2 Source | Transform / Notes |
|---|---|---|---|
| **id** | n/a | n/a | INTEGER generated by `cities_id_seq` |
| **name** | `cities.name` | `cities.name` | Canonical city name |
| **display_name** | `cities.displayName` | `cities.displayName` | User-friendly display name |
| **province_id** | `cities.county` (FK) | `cities.province_id` (FK) | Map to menuca_v3.provinces.id; V1 uses `county` field pointing to `counties` table, V2 uses `province_id` |
| **lat** | `cities.lat` | `cities.lat` | NUMERIC(13,10) - decimal degrees |
| **lng** | `cities.lng` | `cities.lng` | NUMERIC(13,10) - decimal degrees |
| **timezone** | `cities.timezone` | `cities.timezone` | IANA timezone string (e.g., 'America/Toronto') |

**Migration Priority:** 
1. Start with V2 `cities` (cleaner data model with proper province_id FK)
2. Backfill from V1 `cities` for any missing entries
3. Validate coordinates and timezone data

**Data Quality Notes:**
- V1 stores coordinates as VARCHAR(45) - need conversion to NUMERIC
- V2 stores as DECIMAL(13,10) - direct copy
- V1 `county` field maps to V2 `province_id` concept
- Deduplicate by `(name, province_id)` combination

---

## Supporting Geography Tables (Analysis Only)

These tables inform the migration but don't have direct V3 equivalents:

### V1 Address Search Cache (`addresses`)

**Purpose:** Cached geocoding results from address searches

| Column | Description | V3 Usage |
|---|---|---|
| `id` | Primary key | Reference only |
| `search_address` | User's search input | Not migrated - ephemeral data |
| `latitude/longitude` | Geocoded coordinates | Used to validate city coordinates |
| `returned_address` | Formatted address | Reference for validation |
| `city` | City ID (FK to cities) | Validate city references |

**Migration Decision:** ❌ Not migrated to V3. This is runtime cache data that will be regenerated. Can be used for validation during migration.

---

### V2 Address Search Cache (`address_searches`)

**Purpose:** Google Places API results cache (more detailed than V1)

| Column | Description | V3 Usage |
|---|---|---|
| `place_id` | Google Places ID | Not migrated |
| `lat/lng` | Geocoded coordinates | Validation reference |
| `street_number` | Address number | Used in restaurant_locations migration |
| `route` | Street name | Used in restaurant_locations migration |
| `locality` | City name | Validate against cities table |
| `administrative_area_level_1` | Province code | Validate against provinces |
| `postal_code` | Full postal code | Used in restaurant_locations |

**Migration Decision:** ❌ Not migrated to V3. Runtime cache that will be regenerated. However, data can be used to enrich `restaurant_locations` during that migration.

---

### Canadian & US Postal Code Reference

**V1 Tables:** `ca` (Canadian), `us` (US)

**Purpose:** ZIP/Postal code to lat/lng lookup tables

| Table | Rows (est.) | V3 Usage |
|---|---|---|
| `ca` | 917,358 | Validation reference for Canadian addresses |
| `us` | 79,949 | Validation reference for US addresses |

**Migration Decision:** ❌ Not migrated to V3. These are reference tables. V3 will use Google Places API or similar service for geocoding. Tables can be used for validation during migration.

---

### Neighborhood Data (`neighbourhood`)

**Purpose:** Delivery area groupings by neighborhood

| Column | Description | V3 Usage |
|---|---|---|
| `id` | Primary key | Not migrated |
| `city` | City ID | Reference for delivery areas |
| `zip` | Postal code prefix | Not needed in V3 |
| `name` | Neighborhood name | Reference only |
| `area` | BLOB boundary data | Superseded by V2 delivery areas |

**Migration Decision:** ❌ Not migrated to V3. Superseded by V2's `restaurants_delivery_areas` with proper geometry storage. Used only for historical reference.

---

### Restaurant Delivery Areas

**V1:** `restaurant_delivery_areas` - Basic polygon storage
**V2:** `restaurants_delivery_areas` - Improved with PostGIS geometry

**Migration Decision:** ⚠️ Out of scope for Location & Geography entity. This belongs to **Service Configuration & Schedules** or **Delivery Operations** entity. The delivery areas depend on restaurant locations but are operational data, not canonical geography.

**Note:** During Restaurant Management migration, `restaurant_locations` will reference canonical `cities` and `provinces`. Delivery areas will be migrated separately as part of delivery operations.

---

### Restaurant Locations (Multi-location/Franchise)

**V1 Table:** `restaurant_locations` (104 rows)

**Purpose:** Franchise or multi-location restaurant data

| Column | Description | Migration Path |
|---|---|---|
| `id` | Primary key | Not used |
| `name` | Location name | → `menuca_v3.restaurant_locations` (handled in Restaurant Management) |
| `street/city/province/zip` | Address fields | → `menuca_v3.restaurant_locations` |
| `latitude/longitude` | Coordinates | → `menuca_v3.restaurant_locations` |
| `francize` | Franchise ID | Business logic for grouping |
| `phone` | Location phone | → `menuca_v3.restaurant_locations.phone` |

**Migration Decision:** ✅ Migrated as part of **Restaurant Management Entity** to `menuca_v3.restaurant_locations`. This table already exists in V3 schema and references the canonical geography tables (`cities`, `provinces`).

---

## Migration Strategy

### Phase 1: Canonical Geography Tables (THIS ENTITY)

**Priority: HIGH** - Required before Restaurant Management can complete

#### Step 1: Provinces Migration
1. **Source:** V2 `provinces` (authoritative)
2. **Target:** `menuca_v3.provinces`
3. **Validation:** Cross-reference with V1 `counties`
4. **Deduplication:** By `(name, short_name)`

#### Step 2: Cities Migration  
1. **Source:** V2 `cities` (primary), V1 `cities` (backfill)
2. **Target:** `menuca_v3.cities`
3. **Validation:** 
   - Coordinates against V1/V2 `addresses`, `address_searches`
   - Province_id mapping from V1 `county` → V2 `province_id` → V3 `province_id`
4. **Deduplication:** By `(name, province_id)`

### Phase 2: Validation & Data Quality

1. **Coordinate Validation:**
   - Verify all cities have valid lat/lng
   - Check against postal code reference tables (ca/us)
   - Flag cities with missing coordinates

2. **Timezone Validation:**
   - Ensure all Canadian cities have timezone
   - Default 'America/Toronto' for Ontario, 'America/Montreal' for Quebec if missing

3. **Province Linking:**
   - Validate all city → province references
   - Fix orphaned city records

### Phase 3: Documentation & Handoff

The canonical geography tables will be used by:
1. **Restaurant Management** - `restaurant_locations.city`, `restaurant_locations.province_id`
2. **Delivery Operations** - Delivery area definitions reference cities
3. **User Addresses** - Customer delivery addresses reference cities/provinces

---

## Data Quality Recommendations

### Provinces Table
- ✅ V2 data is clean and complete
- Validate short_name uniqueness
- Ensure language_id is consistent (1 = English, 2 = French)

### Cities Table
- ⚠️ V1 uses `county` field name (should be province)
- ⚠️ V1 coordinates stored as VARCHAR - validate numeric conversion
- ✅ V2 has proper data types (DECIMAL for coordinates)
- Implement fuzzy matching for city name variations
- Handle bilingual city names (Montreal/Montréal)

### Missing Data Handling
- Cities without coordinates: Geocode using Google Places API
- Cities without timezone: Derive from province
- Orphaned cities (no province): Flag for manual review

---

## Out of Scope for This Entity

The following tables are **NOT** part of Location & Geography canonical data:

1. **Delivery Areas:** `restaurant_delivery_areas`, `restaurants_delivery_areas`
   - Belongs to: Delivery Operations entity
   - Depends on: Canonical cities/provinces

2. **Restaurant Locations:** `restaurant_locations` (V1), `restaurants` (address fields)
   - Belongs to: Restaurant Management entity  
   - References: Canonical cities/provinces

3. **User Addresses:** `users_delivery_addresses`, `site_users_delivery_addresses`
   - Belongs to: Users & Access entity
   - References: Canonical cities/provinces

4. **Address Search Cache:** `addresses` (V1), `address_searches` (V2)
   - Runtime data, not canonical
   - Will be regenerated in V3

---

## Linking Rules

1. **Provinces First:** Migrate `menuca_v3.provinces` before cities
2. **Cities Reference Provinces:** All city records must have valid province_id FK
3. **Downstream Entities:** Restaurant locations, delivery areas, user addresses will reference these canonical tables

---

## Verification Queries

### Provinces Migration Verification

```sql
-- Count comparison
SELECT 'V1' as source, COUNT(*) as cnt FROM menuca_v1.counties
UNION ALL
SELECT 'V2' as source, COUNT(*) FROM menuca_v2.provinces
UNION ALL
SELECT 'V3' as source, COUNT(*) FROM menuca_v3.provinces;

-- Duplicate check
SELECT name, short_name, COUNT(*) as cnt
FROM menuca_v3.provinces
GROUP BY name, short_name
HAVING COUNT(*) > 1;

-- Orphaned cities check (should be 0)
SELECT c.id, c.name, c.province_id
FROM menuca_v3.cities c
LEFT JOIN menuca_v3.provinces p ON p.id = c.province_id
WHERE p.id IS NULL;
```

### Cities Migration Verification

```sql
-- Count comparison
SELECT 'V1' as source, COUNT(*) as cnt FROM menuca_v1.cities
UNION ALL  
SELECT 'V2' as source, COUNT(*) FROM menuca_v2.cities
UNION ALL
SELECT 'V3' as source, COUNT(*) FROM menuca_v3.cities;

-- Missing coordinates check
SELECT id, name, province_id
FROM menuca_v3.cities
WHERE lat IS NULL OR lng IS NULL;

-- Missing timezone check  
SELECT id, name, province_id
FROM menuca_v3.cities
WHERE timezone IS NULL OR timezone = '';

-- Duplicate cities per province
SELECT name, province_id, COUNT(*) as cnt
FROM menuca_v3.cities
GROUP BY name, province_id
HAVING COUNT(*) > 1;
```

---

## Next Steps

After this entity is migrated:

1. ✅ **Restaurant Management** can complete `restaurant_locations` migration using canonical geography FKs
2. ✅ **Delivery Operations** can migrate delivery areas with proper city/province references
3. ✅ **Users & Access** can migrate user addresses with validated geography data
4. ✅ **All entities** have consistent, normalized geography data

---

## Notes

- This entity is foundational - must be completed early in migration
- Focus on data quality: coordinates, timezones, province linkage
- V2 `provinces` and `cities` are more mature than V1 - prefer V2 as source
- Keep V1 data for validation and backfill only
- Runtime cache tables (addresses, address_searches) are out of scope
