## menuca_v3.restaurant_locations — Migration Plan

### Purpose
Migrate restaurant physical location data from V1 and V2 `restaurants` tables (which contained embedded location fields) into the normalized `menuca_v3.restaurant_locations` table. This migration extracts address, geographic, and contact information that was previously stored directly in the restaurant record into a separate, relational location table that supports future multi-location scenarios.

### Source vs Target Mapping Analysis

**Sources consulted:**

- V1 schema `restaurants` table (lines 1494-1680 in menuca_v1_structure.sql):
  - Location fields: `address`, `city`, `province`, `zip`, `phone`, `mainEmail`
  - Geographic fields: `latitude`, `longitude`
  - Status field: `active` (enum 'Y','N')
  
- V2 schema `restaurants` table (lines 988-1031 in menuca_v2_structure.sql):
  - Location fields: `address`, `city_id`, `province_id`, `zip`, `phone`, `email`
  - Geographic fields: `lat`, `lng` (decimal 10,7)
  - Status field: `active` (enum 'y','n')

- V2 `menuca_v2_restaurants_dump.sql`: Contains 629 restaurant records with actual location data

**Target schema: `menuca_v3.restaurant_locations`** (lines 67-96 in menuca_v3.sql):
- Primary key: `id` (bigint BIGSERIAL)
- External identifier: `uuid` (UUID, auto-generated)
- Foreign key: `restaurant_id` (bigint, references menuca_v3.restaurants)
- Location flags: `is_primary` (boolean, default true), `is_active` (boolean, default true)
- Address components: `street_address`, `unit_number`, `city`, `province_id`, `postal_code`, `country_code`
- Geographic: `latitude` (numeric 13,10), `longitude` (numeric 13,10)
- Contact: `phone`, `email`
- Timestamps: `created_at`, `updated_at`

---

## Field Mapping

**Source: V1 `restaurants` AND V2 `restaurants`**

Both V1 and V2 store location data **inline** within the restaurants table. This migration extracts that data into a dedicated location record.

| Target Column | V1 Source Column | V2 Source Column | Transform / Notes |
|---|---|---|---|
| **id** | n/a | n/a | BIGSERIAL generated by `restaurant_locations_id_seq` |
| **uuid** | n/a | n/a | `uuid_generate_v4()` default |
| **restaurant_id** | FK to `restaurants.id` | FK to `restaurants.id` | Resolve via: `menuca_v3.restaurants.legacy_v1_id = v1.restaurants.id` OR `menuca_v3.restaurants.legacy_v2_id = v2.restaurants.id` |
| **is_primary** | n/a | n/a | Set to `TRUE` for all initial records (one location per restaurant in legacy data) |
| **street_address** | `restaurants.address` (text) | `restaurants.address` (varchar 125) | Direct copy; trim whitespace |
| **unit_number** | n/a | n/a | NULL initially; could parse from `address` if format is consistent (e.g., "Unit 5") |
| **city** | `restaurants.city` (varchar 20) | `restaurants.city_id` → lookup | **V1**: Direct copy of city name string<br>**V2**: Resolve `city_id` via lookup to `menuca_v2.cities.name`; if no match, NULL |
| **province_id** | `restaurants.province` (varchar 50) | `restaurants.province_id` (int) | **V1**: Map province name/abbreviation string to `menuca_v3.provinces.id` via lookup<br>**V2**: Direct copy of province_id |
| **postal_code** | `restaurants.zip` (varchar 100) | `restaurants.zip` (varchar 10) | Direct copy; normalize to uppercase, remove spaces |
| **country_code** | `restaurants.country` (int) | n/a | **V1**: If `country = 0` → 'CA', if `country = 1` → 'US', else NULL<br>**V2**: Default 'CA' |
| **latitude** | `restaurants.latitude` (varchar 45) | `restaurants.lat` (decimal 10,7) | Cast to `numeric(13,10)`; handle empty strings as NULL |
| **longitude** | `restaurants.longitude` (varchar 45) | `restaurants.lng` (decimal 10,7) | Cast to `numeric(13,10)`; handle empty strings as NULL |
| **phone** | `restaurants.phone` (text) | `restaurants.phone` (varchar 20) | Direct copy; already normalized in V2 data |
| **email** | `restaurants.mainEmail` (varchar 125) | `restaurants.email` (varchar 125) | Lowercase and trim; prefer V2 if both exist |
| **is_active** | `restaurants.active` (enum) | `restaurants.active` (enum) | Map: 'Y'/'y' → true, 'N'/'n' → false; default true |
| **created_at** | `restaurants.addedon` (timestamp) | `restaurants.added_at` (timestamp) | Convert to timestamptz; V1 is already timestamp, V2 is timestamp |
| **updated_at** | n/a | `restaurants.updated_at` (datetime) | V2 only; convert to timestamptz; V1 has no equivalent |

---

## Key Observations

### 1. **No Separate Location Table in V1/V2**
Unlike other entities (contacts, domains), V1 and V2 did **not** have a separate `restaurants_locations` table. All location data was embedded directly in the `restaurants` table. This means:
- One restaurant = one location in legacy data
- All initial `restaurant_locations` records will have `is_primary = TRUE`
- The migration creates a 1:1 relationship initially, but the v3 schema supports future 1:many

### 2. **City Representation Differs**
- **V1**: Stores city as a **text string** (e.g., "Ottawa", "Gatineau")
- **V2**: Stores `city_id` as an **integer FK** to `menuca_v2.cities` table
- **Resolution**: 
  - V1 cities will be copied as-is (text)
  - V2 cities require lookup to resolve `city_id → city_name`
  - Consider creating a staging query to pre-resolve V2 city names

### 3. **Province Representation Differs**
- **V1**: Stores province as a **text string** (e.g., "Ontario", "ON", "Quebec", "QC")
- **V2**: Stores `province_id` as an **integer FK** to `menuca_v2.provinces` table
- **Resolution**:
  - V1 provinces need mapping: text → `menuca_v3.provinces.id`
  - V2 provinces can be copied directly if `menuca_v3.provinces` IDs align with V2
  - May need a lookup table for V1 province name/abbreviation → province_id

### 4. **Data Type Conversions**
- **Latitude/Longitude**:
  - V1: stored as `varchar(45)` (string) — may contain empty strings, need NULL handling
  - V2: stored as `decimal(10,7)` (proper numeric)
  - V3: expects `numeric(13,10)` (higher precision)
  
- **Phone**:
  - V1: stored as `text` (unlimited length, inconsistent format)
  - V2: stored as `varchar(20)` (more constrained)
  - V3: expects `varchar(20)` — may need truncation/validation for V1 data

### 5. **Country Code**
- V1 has a `country` integer field (0 = Canada, likely 1 = US)
- V2 has no country field (implicit Canada)
- V3 expects ISO 2-letter code ('CA', 'US')
- Map V1 `country` values appropriately

### 6. **Unit Number Parsing**
- Neither V1 nor V2 have a separate `unit_number` field
- V3 has `unit_number` (varchar 20) to support addresses like "Unit 5, 123 Main St"
- Consider optional parsing of V1/V2 `address` to extract unit/suite numbers

### 7. **Email Priority**
- When both V1 and V2 records exist for the same restaurant:
  - V1 uses `mainEmail`
  - V2 uses `email`
  - Prefer V2 if populated, fallback to V1

---

## Data Quality Considerations

### ✅ **Expected Data Quality**
- V2 data is generally cleaner (normalized city/province IDs, proper decimal lat/lng)
- V2 phone numbers appear to be in standardized format
- Most restaurants should have at least `address` and `city`

### ⚠️ **Potential Data Issues**
1. **Missing Geographic Coordinates**
   - Many legacy records may have NULL or (0.0, 0.0) coordinates
   - Consider geocoding service to backfill post-migration
   
2. **Inconsistent Address Formatting**
   - V1 addresses are free-text, may include unit numbers, directions, etc.
   - Consider address normalization pass
   
3. **Province Text Variations in V1**
   - May have "Ontario", "ON", "Ont", "Ont.", etc.
   - Need robust lookup table for mapping

4. **Phone Number Format**
   - V1 phone numbers may have inconsistent formats
   - V2 appears more standardized
   - May need format validation/normalization

5. **Empty/Placeholder Data**
   - Test records like "600 Terry Fox Drive" appear multiple times
   - Coordinates (45.3003900,-75.9069158) reused for test restaurants
   - Filter or flag test data during migration

---

## Migration Strategy (High-Level)

### Approach: **Two-Pass Merge with V2 Priority**

1. **Pass 1: V1 Baseline**
   - Insert location record for every V1 restaurant
   - Use V1 data for all fields
   - Map V1 province text to province_id via lookup
   - Set `is_primary = TRUE`

2. **Pass 2: V2 Updates/Overwrite**
   - For restaurants with `legacy_v2_id`:
     - UPDATE existing location with V2 data (cleaner city_id, province_id, lat/lng)
     - Prefer V2 `email` over V1 `mainEmail`
     - Keep V1 `phone` if V2 is NULL
   - For V2 orphaned restaurants (no V1 link):
     - INSERT new location record

3. **Pass 3: Post-Load Cleanup**
   - Normalize postal codes (uppercase, remove spaces)
   - Validate phone number format
   - Flag records with (0.0, 0.0) coordinates for geocoding
   - Identify and mark test records

---

## Next Steps

1. ✅ Create staging tables for V1 and V2 location data
2. ✅ Build province text → province_id lookup table
3. ✅ Build city_id → city_name lookup for V2
4. ⬜ Write SQL for Pass 1 (V1 baseline insert)
5. ⬜ Write SQL for Pass 2 (V2 updates/inserts)
6. ⬜ Write verification queries
7. ⬜ Execute migration
8. ⬜ Post-migration cleanup and quality checks

---

## Dependencies

**Must complete before starting:**
- ✅ `menuca_v3.restaurants` migration (provides `restaurant_id` FK target)
- ✅ `menuca_v3.provinces` migration (provides `province_id` lookup)
- ⬜ `menuca_v3.cities` migration (optional, for future city_id FK)

**Blocks:**
- Any downstream processes that reference restaurant location data

---

## Scope

**In Scope:**
- All V1 `restaurants` records with location data
- All V2 `restaurants` records (both linked and orphaned)
- One location per restaurant (1:1 mapping)

**Out of Scope:**
- Multi-location restaurants (not in legacy data)
- Historical location changes (no audit trail in V1/V2)
- Address validation/geocoding (post-migration enhancement)
- Delivery zones/radius (separate feature, stored as BLOB in V1)

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Province mapping errors (V1) | Medium | High | Pre-validate all unique province values against lookup table |
| Missing city names (V2) | Low | Medium | Log records with unresolvable city_id for manual review |
| Coordinate precision loss | Low | Low | V3 supports higher precision than V2; no data loss expected |
| Email conflicts (V1 vs V2) | Low | Low | V2 takes priority; document override logic |
| Test data pollution | Medium | Low | Flag known test addresses/coordinates |



